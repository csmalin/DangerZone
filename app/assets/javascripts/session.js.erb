var map = L.mapbox.map('map', 'alex-ray.map-p9i5ggnv');
map.current_location = {lat: 0, lon: 0};
var marker = L.marker([0,0],
                {icon: L.icon({
                    iconUrl: "http://i.imgur.com/FOqzufV.png",
                    iconSize:[35, 35],
                    iconAnchor:[25, 25],
                    popupAnchor:[0, -25]
                  })
              });
$(document).ready(function(){
  navigator.geolocation.requestCurrentPosition(map.showPosition, map.errorCallback, map.timeoutCallback, 5000);
  map.searchLocationFormInit();

  map.on("click",function(e){
    var latitude = e.latlng.lat;
    var longitude = e.latlng.lng;
    var date = new Date();
    var weekday=new Array(7);
        weekday[0]="Sunday";
        weekday[1]="Monday";
        weekday[2]="Tuesday";
        weekday[3]="Wednesday";
        weekday[4]="Thursday";
        weekday[5]="Friday";
        weekday[6]="Saturday";
    var day = weekday[date.getDay()]
    var hours_mins = date.getHours() + ":" + date.getMinutes()
    var date = date.getFullYear()+ "-" +date.getMonth()+ "-" + date.getDate() + " " + date.getHours() + ":" + date.getMinutes()+ ":" + date.getSeconds() ;
    var report_incident_form_template = '<b>Report an incident:</b><form id="report-form" class="report-incident"><input type="hidden" name="hours_mins" value='+hours_mins+'><input type="hidden" name="date" value='+date+'><input type="hidden" name="day" value='+day+'><input type="hidden" name="longitude" value='+longitude+'><input type="hidden" name="latitude" value='+latitude+'><textarea name="incident" rows= "4" cols="40" placeholder="Report here!"></textarea><br/><b>Select category:</b><div class="options"><select name="options" size="5"><option value="arson" >ARSON</option><option value="assault" >ASSAULT</option><option value="bad checks" >BAD CHECKS</option><option value="burglary" >BURGLARY</option><option value="disorderly conduct" >DISORDERLY CONDUCT</option><option value="driving under the influence" >DRIVING UNDER THE INFLUENCE</option><option value="drug/narcotic" >DRUG/NARCOTIC</option><option value="drunkeness" >DRUNKENNESS</option><option value="embezzlement" >EMBEZZLEMENT</option><option value="extortion" >EXTORTION</option><option value="family offenses" >FAMILY OFFENSES</option><option value="forgery/counterfeiting" >FORGERY/COUNTERFEITING</option><option value="fraud" >FRAUD</option><option value="gambling" >GAMBLING</option><option value="kidnapping" >KIDNAPPING</option><option value="larceny/theft" >LARCENY/THEFT</option><option value="liquor laws" >LIQUOR LAWS</option><option value="loitering" >LOITERING</option><option value="missing person" >MISSING PERSON</option><option value="non-criminal" >NON-CRIMINAL</option><option value="other offenses" >OTHER OFFENSES</option><option value="prostitution" >PROSTITUTION</option><option value="recovered vehicle" >RECOVERED VEHICLE</option><option value="robery" >ROBBERY</option><option value="runaway" >RUNAWAY</option><option value="sex offenses, forcible" >SEX OFFENSES, FORCIBLE</option><option value="sex offenses, non forcible" >SEX OFFENSES, NON FORCIBLE</option><option value="suicide" >SUICIDE</option><option value="suspicious occ" >SUSPICIOUS OCC</option><option value="trespass" >TRESPASS</option><option value="vandalism" >VANDALISM</option><option value="vehicle theft" >VEHICLE THEFT</option><option value="warrants" >WARRANTS</option><option value="weapon laws">WEAPON LAWS</option></select></div><br><input id ="submit" type="submit" value="Report"></form>';

    $('.leaflet-popup-pane').show();
    var marker =L.mapbox.markerLayer({
      type: 'Feature',
      geometry: {
        type: 'Point',
        coordinates: [e.latlng.lng,e.latlng.lat]
      },
      properties: {
        url: 'http://en.wikipedia.org/wiki/Baltimore',
        title: '',
        description: report_incident_form_template,
        'marker-size': 'large',
        'marker-color': '#f0a'
      }
    }).addTo(map);
  });

$(document).delegate("#report-form","submit",function(e){
  e.preventDefault();
  $('.leaflet-popup-pane').hide();
  $.post('/crimes',$('form#report-form').serialize(), function(response) {
  },'json');

});

map.getCrimes();
console.log('after get crimes function()');
});

map.searchLocationFormInit = function(){
  $('div.search img').click(function(){
    $('div.search').toggleClass('open');
  });

  $('form.location-search').on('submit', function(event){
    event.preventDefault();
    var data = $(this).serialize();

    $.getJSON('/geocoder?'+data, function(data){
      var pos = data.pos.split(" ");
      map.current_location.lon = pos[0];
      map.current_location.lat = pos[1];

      console.log(map.current_location.lat);
      console.log(map.current_location.lon);
      map.setView([map.current_location.lat, map.current_location.lon], 18);
      marker.setLatLng([map.current_location.lat, map.current_location.lon]).addTo(map);

      map.formClose();
    }, function(error){
      map.alertFlash(error.message);
    });

  });
}



map.flash = function(message, type){
  $('.flash').addClass(type).text(message);
  window.setTimeout(function(){
    $('.flash').removeClass(type);
  }, 4000);
}

map.formOpen = function(){
  $('div.search').addClass('open');
}

map.formClose = function(){
  $('div.search').removeClass('open');
}

map.timeoutCallback = function(){
  map.formOpen();
  map.flash("Enter your location!", "warning");
}

map.showPosition = function(pos) {
    map.current_location.lat = pos.coords.latitude;
    map.current_location.lon = pos.coords.longitude;
    console.log(map.current_location.lat);
    console.log(map.current_location.lon);
    map.getCrimes();

    map.setView([map.current_location.lat, map.current_location.lon], 18);
    marker.setLatLng([map.current_location.lat, map.current_location.lon]).addTo(map);
}

map.errorCallback = function(error){
  if(error.PERMISSION_DENIED){
    map.flash("Enable your Geo Location!", "alert");
  } else if(error.POSITION_UNAVAILABLE){
    map.flash("Enter a location!", "alert");
  } else if(error.TIMEOUT){
    map.flash("hmmm we timed out trying to find where you are hiding!", "alert");
  }
}

navigator.geolocation.requestCurrentPosition = function(successCB, errorCB, timeoutCB, timeoutThreshold){
  var successHandler = successCB;
  var errorHandler = errorCB;

  window.geolocationTimeoutHandler = function(){
    timeoutCB();
  }

  if (typeof(geolocationRequestTimeoutHandler) != 'undefined'){
    clearTimeout(window['geolocationRequestTimeoutHandler']);//clear any previous timers
  }

  var timeout = timeoutThreshold || 40000;//60 seconds
  window['geolocationRequestTimeoutHandler'] = setTimeout('geolocationTimeoutHandler()', timeout);//set timeout handler

  navigator.geolocation.watchPosition(
    function(position){
      clearTimeout(window['geolocationRequestTimeoutHandler']);
      successHandler(position);
    },
    function(error){
      clearTimeout(window['geolocationRequestTimeoutHandler']);
      errorHandler(error);
    },{enableHighAccuracy: true});
};

map.getCrimes = function(){
  console.log('crimes');
  console.log(map.current_location.lat);
  console.log(map.current_location.lon);
  $.getJSON('/crimes?distance=1000&location='+map.current_location.lat+' '+map.current_location.lon, function(data) {
    var crimes =  data;
    console.log("get json called to /crimes route");
    console.log(data);

    for (x in crimes){
      L.circle([crimes[x].latitude,crimes[x].longitude],10,{color:'red'},{opacity:'5.0'}).addTo(map);
    }


    function onMapClick(event) {
     popup
     .setLatLng(event.latlng)
     .setContent("You clicked the map at " + e.latlng.toString())
     .openOn(map);
   }
 });
 };








